<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campa√±a Fundaci√≥n - Toca la Campana</title>
    
    <!-- 1. Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Importaciones -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lilita+One&family=Quicksand:wght@400;500;600;700&display=swap');
        .font-lilita { font-family: 'Lilita One', cursive; }
        .font-quicksand { font-family: 'Quicksand', sans-serif; }
        body { background-color: #0098d9; overflow-x: hidden; }
        
        @keyframes swing { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(20deg); } 50% { transform: rotate(-18deg); } 75% { transform: rotate(12deg); } }
        .bell-swing { animation: swing 1.2s ease-in-out; transform-origin: top center; }
        
        @keyframes wave { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(2.8); opacity: 0; } }
        
        .wave-ring { 
            border-radius: 50%; 
            border: 4px solid rgba(255, 215, 0, 0.4); 
            position: absolute; 
            animation: wave 2s infinite;
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from 'firebase/firestore';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';

        // TUS CLAVES REALES
        const firebaseConfig = {
          apiKey: "AIzaSyCO9aonuABDfwjRjmUTKnPGgKRfNVP5VjU",
          authDomain: "campana-fundacion.firebaseapp.com",
          projectId: "campana-fundacion",
          storageBucket: "campana-fundacion.firebasestorage.app",
          messagingSenderId: "641556114718",
          appId: "1:641556114718:web:0de23bcb20481b19a86d0f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const App = () => {
          const [user, setUser] = useState(null);
          const [leads, setLeads] = useState([]);
          const [messages, setMessages] = useState([]);
          const [showLeadModal, setShowLeadModal] = useState(false);
          const [showThanksModal, setShowThanksModal] = useState(false);
          const [isSwinging, setIsSwinging] = useState(false);
          const [formData, setFormData] = useState({ name: '', email: '' });
          const [messageData, setMessageData] = useState('');
          const [loading, setLoading] = useState(false);
          const [errorMessage, setErrorMessage] = useState('');
          
          const audioContextRef = useRef(null);

          useEffect(() => {
            signInAnonymously(auth).catch((error) => console.error("Error Auth:", error));
            return onAuthStateChanged(auth, setUser);
          }, []);

          useEffect(() => {
            const leadsRef = collection(db, 'leads');
            const msgsRef = collection(db, 'messages');

            const unsubLeads = onSnapshot(leadsRef, (snapshot) => {
              setLeads(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });

            const unsubMsgs = onSnapshot(msgsRef, (snapshot) => {
              const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
              setMessages(data);
            });

            return () => { unsubLeads(); unsubMsgs(); };
          }, []);

          const playBellSound = async () => {
            try {
              if (!audioContextRef.current) {
                 audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
              }
              const ctx = audioContextRef.current;
              
              if (ctx.state === 'suspended') {
                await ctx.resume();
              }
              
              const now = ctx.currentTime;
              
              [0, 0.2, 0.4, 0.6].forEach((offset, i) => {
                  const t = now + offset;
                  const osc = ctx.createOscillator();
                  const gain = ctx.createGain();

                  osc.connect(gain);
                  gain.connect(ctx.destination);

                  osc.frequency.setValueAtTime(2000 + (i * 50), t); 
                  osc.type = 'sine'; 

                  gain.gain.setValueAtTime(0, t);
                  gain.gain.linearRampToValueAtTime(0.6, t + 0.01); 
                  gain.gain.exponentialRampToValueAtTime(0.001, t + 0.3);

                  osc.start(t);
                  osc.stop(t + 0.35);
              });

            } catch (e) {
                console.log("Audio no permitido por el navegador.");
            }
          };

          const handleRing = () => {
            setIsSwinging(true);
            playBellSound();
            
            setTimeout(() => setIsSwinging(false), 1200);
            setTimeout(() => {
              setErrorMessage('');
              setShowLeadModal(true);
            }, 1000);
          };

          const submitLead = async (e) => {
            e.preventDefault();
            if (!user) { alert("Conectando... espera 2 seg."); return; }
            setLoading(true);
            setErrorMessage('');

            if (!formData.email.includes('@')) {
                setErrorMessage("Email incorrecto"); setLoading(false); return;
            }

            // --- PROTECCI√ìN DUPLICADOS ---
            const emailExists = leads.some(lead => lead.email?.toLowerCase() === formData.email.toLowerCase());
            
            if (emailExists) {
                setErrorMessage("¬°Este correo ya registr√≥ su eco! Gracias üíú");
                setLoading(false);
                return;
            }

            try {
              await addDoc(collection(db, 'leads'), {
                name: formData.name,
                email: formData.email.toLowerCase(),
                uid: user.uid,
                timestamp: serverTimestamp(),
              });
              setShowLeadModal(false);
              setShowThanksModal(true);
            } catch (err) {
              alert("Error al guardar: " + err.message);
            } finally {
              setLoading(false);
            }
          };

          const submitMessage = async (e) => {
            e.preventDefault();
            if (!messageData.trim()) return;
            setLoading(true);
            try {
              await addDoc(collection(db, 'messages'), {
                name: formData.name || 'An√≥nimo',
                message: messageData,
                timestamp: serverTimestamp(),
              });
              setMessageData('');
              setShowThanksModal(false);
            } catch (err) {
              alert("Error al enviar mensaje");
            } finally {
              setLoading(false);
            }
          };

          const totalEchos = leads.length;
          const workshops = Math.floor(totalEchos / 100);
          const progress = totalEchos % 100;

          return (
            <div className="min-h-screen w-full bg-gradient-to-br from-[#0098d9] via-[#116cc5] to-[#0098d9] font-sans text-white overflow-x-hidden p-2 md:p-4 flex flex-col items-center pb-8">
              
              {/* --- HEADER CON LOGO BLANCO REAL --- */}
              <header className="text-center mb-4 mt-2 animate-in fade-in slide-in-from-top duration-700 w-full max-w-2xl px-4">
                
                <img 
                    src="https://fundacionabrazaunsueno.com/wp-content/uploads/2026/01/logo-faus-blanco.png" 
                    alt="Fundaci√≥n Abraza un Sue√±o" 
                    className="h-24 md:h-32 mx-auto mb-3 object-contain drop-shadow-md" 
                />

                <h1 className="font-lilita text-4xl md:text-5xl mb-3 drop-shadow-xl text-[#ffd058]" style={{textShadow: '2px 2px 0px #116cc5'}}>Toca la Campana</h1>
                
                <div className="bg-white/10 backdrop-blur-sm rounded-xl p-3 border border-white/10">
                    <p className="text-sm md:text-base font-quicksand font-medium leading-tight mb-2 opacity-95">
                        Haz que la esperanza tambi√©n suene para otros ni√±os que contin√∫an su lucha.
                    </p>
                    <p className="text-xs md:text-sm font-quicksand font-bold text-[#ffd058] uppercase tracking-wide">
                        Cada 100 campanadas, un ni√±o recibe un kit de arteterapia üé®
                    </p>
                </div>
              </header>

              {/* CONTADORES */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 w-full max-w-3xl mb-4">
                <div className="bg-white rounded-2xl p-3 text-center shadow-lg transform hover:scale-105 transition-all">
                  <div className="font-lilita text-4xl text-[#0098d9]">{workshops}</div>
                  <div className="text-[#116cc5] text-sm font-bold uppercase tracking-wide">Talleres Logrados</div>
                </div>
                <div className="bg-white rounded-2xl p-3 text-center shadow-lg transform hover:scale-105 transition-all">
                  <div className="font-lilita text-4xl text-[#0098d9]">{totalEchos}</div>
                  <div className="text-[#116cc5] text-sm font-bold uppercase tracking-wide">Ecos Totales</div>
                </div>
              </div>

              {/* BARRA DE PROGRESO */}
              <div className="w-full max-w-2xl mb-6 px-2">
                <div className="bg-[#116cc5]/30 backdrop-blur-md rounded-full p-1.5 border border-white/20">
                  <div className="bg-white/20 h-8 rounded-full overflow-hidden relative">
                    <div className="h-full bg-gradient-to-r from-[#ffd058] to-[#ffb800]" style={{ width: `${progress}%`, transition: 'width 1s ease' }}></div>
                    <div className="absolute inset-0 flex items-center justify-center font-bold text-white drop-shadow-md text-sm">
                      Faltan {100 - progress} ecos para el pr√≥ximo taller
                    </div>
                  </div>
                </div>
              </div>

              {/* CAMPANA Y ONDAS */}
              <div className="relative mb-4 flex items-center justify-center h-40 md:h-52 pointer-events-none">
                <div className="wave-ring w-40 h-40 md:w-56 md:h-56" style={{ animationDelay: '0s' }}></div>
                <div className="wave-ring w-40 h-40 md:w-56 md:h-56" style={{ animationDelay: '0.6s' }}></div>
                
                <div onClick={handleRing} className={`cursor-pointer z-10 relative transition-all hover:scale-110 active:scale-95 pointer-events-auto ${isSwinging ? 'bell-swing' : ''}`}>
                   <svg width="160" height="160" viewBox="0 0 200 200" className="drop-shadow-2xl md:w-[200px] md:h-[200px]">
                    <defs>
                      <linearGradient id="goldGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style={{stopColor:'#ffd700'}} />
                        <stop offset="100%" style={{stopColor:'#d4af37'}} />
                      </linearGradient>
                    </defs>
                    <g transform="translate(100, 50)">
                      <rect x="-5" y="-20" width="10" height="25" rx="3" fill="#d4af37" />
                      <path d="M -50 80 Q -50 20 0 0 Q 50 20 50 80 Z" fill="url(#goldGrad)" />
                      <ellipse cx="0" cy="80" rx="55" ry="15" fill="#d4af37" />
                      <ellipse cx="0" cy="80" rx="52" ry="13" fill="url(#goldGrad)" />
                      <circle cx="0" cy="75" r="8" fill="#654321" />
                    </g>
                  </svg>
                </div>
              </div>

              {/* BOT√ìN */}
              <button 
                onClick={handleRing} 
                className="relative z-50 bg-[#ffd058] text-[#116cc5] font-lilita text-xl md:text-2xl px-8 py-3 rounded-full shadow-xl hover:bg-[#ffb800] hover:scale-105 active:scale-95 transition-all mb-8 border-b-4 border-[#d4af37]"
              >
                ¬°HACER SONAR!
              </button>

              {/* MURAL */}
              <div className="w-full max-w-4xl mb-8 px-2">
                <div className="flex items-center justify-center gap-2 mb-4">
                    <h2 className="font-lilita text-2xl md:text-3xl text-white drop-shadow-md">Mural de Esperanza</h2>
                    <span className="text-2xl">üíå</span>
                </div>
                
                <div className="bg-white/10 backdrop-blur-sm rounded-[20px] p-4 border border-white/20 min-h-[200px] max-h-[400px] overflow-y-auto custom-scrollbar">
                  {messages.length === 0 ? (
                    <div className="text-center text-white/70 font-quicksand text-base italic py-8">
                      <p>A√∫n no hay mensajes.</p>
                      <p className="text-xs mt-1">¬°S√© el primero en dejar uno!</p>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                      {messages.map((m, idx) => {
                        const rotateClass = idx % 2 === 0 ? 'rotate-1' : '-rotate-1';
                        return (
                          <div key={idx} className={`bg-white p-4 rounded-lg shadow-md transform ${rotateClass} hover:rotate-0 transition-all hover:z-10`}>
                            <div className="flex justify-between mb-2 border-b border-gray-100 pb-1">
                              <span className="font-bold text-[#116cc5] uppercase text-[10px] tracking-wider truncate mr-2">{m.name}</span>
                              <span className="text-red-400 text-xs">üìå</span>
                            </div>
                            <p className="text-gray-600 font-quicksand italic text-xs leading-relaxed line-clamp-4">"{m.message}"</p>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>

              {/* PIE DE P√ÅGINA */}
              <div className="w-full max-w-xl px-2">
                  <div className="bg-white rounded-2xl p-4 text-center shadow-xl border-b-4 border-[#ffd058] transform hover:scale-105 transition-all">
                    <p className="text-[#116cc5] text-lg font-bold flex flex-col md:flex-row items-center justify-center gap-2">
                        <span>üé®</span>
                        <span>Cada eco financia alegr√≠a</span>
                        <span>üíú</span>
                    </p>
                  </div>
              </div>

              {/* Modales */}
              {showLeadModal && (
                <div className="fixed inset-0 bg-[#001f3f]/90 flex items-center justify-center z-50 p-4 backdrop-blur-sm" style={{zIndex: 100}}>
                  <div className="bg-white rounded-[20px] p-6 max-w-xs w-full text-center shadow-2xl relative animate-in zoom-in duration-300">
                    <button onClick={() => setShowLeadModal(false)} className="absolute top-3 right-3 text-gray-400 text-xl">&times;</button>
                    <div className="text-4xl mb-2">üîî</div>
                    <h2 className="text-[#116cc5] font-lilita text-2xl mb-1">¬°Tu eco suena!</h2>
                    <p className="text-gray-500 mb-4 text-xs">Completa tus datos para sumar</p>
                    
                    {errorMessage && <div className="bg-red-100 text-red-600 p-2 rounded mb-2 text-xs font-bold">{errorMessage}</div>}
                    
                    <form onSubmit={submitLead} className="space-y-3">
                      <input type="text" placeholder="Tu nombre" className="w-full bg-gray-50 border-2 border-gray-100 rounded-lg px-3 py-2 outline-none focus:border-[#0098d9] text-gray-700 text-sm" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required />
                      <input type="email" placeholder="tu@email.com" className="w-full bg-gray-50 border-2 border-gray-100 rounded-lg px-3 py-2 outline-none focus:border-[#0098d9] text-gray-700 text-sm" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} required />
                      <button type="submit" disabled={loading} className="w-full bg-[#116cc5] text-white font-bold py-2 rounded-lg hover:bg-[#005bb5] transition-colors shadow-md text-sm">
                        {loading ? '...' : 'Confirmar'}
                      </button>
                    </form>
                  </div>
                </div>
              )}

              {showThanksModal && (
                <div className="fixed inset-0 bg-[#001f3f]/90 flex items-center justify-center z-50 p-4 backdrop-blur-sm" style={{zIndex: 100}}>
                  <div className="bg-white rounded-[20px] p-6 max-w-xs w-full text-center shadow-2xl animate-in zoom-in duration-300">
                    <div className="text-4xl mb-2">üíõ</div>
                    <h2 className="text-[#116cc5] font-lilita text-2xl mb-1">¬°Gracias!</h2>
                    <p className="text-gray-500 mb-4 text-xs">Deja un mensaje en el mural</p>
                    <form onSubmit={submitMessage}>
                      <textarea className="w-full bg-[#f0f9ff] border-none rounded-lg p-3 text-gray-700 mb-3 focus:ring-2 focus:ring-[#116cc5] outline-none h-24 resize-none text-xs" placeholder="Escribe algo bonito..." value={messageData} onChange={e => setMessageData(e.target.value)}></textarea>
                      <div className="flex gap-2">
                        <button type="button" onClick={() => setShowThanksModal(false)} className="flex-1 py-2 text-gray-400 font-bold text-xs">Saltar</button>
                        <button type="submit" disabled={loading} className="flex-1 bg-[#ffd058] text-[#116cc5] font-bold py-2 rounded-lg hover:bg-[#ffb800] shadow-md text-xs">
                          {loading ? '...' : 'Publicar'}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              )}

            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
