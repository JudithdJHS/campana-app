<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampaÃ±a FundaciÃ³n - Toca la Campana</title>
    
    <!-- 1. Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Mapa de Importaciones (Esto hace que los 'import' funcionen en el navegador) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"
      }
    }
    </script>

    <!-- 3. Cargar Babel para entender JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lilita+One&family=Quicksand:wght@400;600;700&display=swap');
        .font-lilita { font-family: 'Lilita One', cursive; }
        .font-quicksand { font-family: 'Quicksand', sans-serif; }
        
        @keyframes swing {
          0%, 100% { transform: rotate(0deg); }
          25% { transform: rotate(20deg); }
          50% { transform: rotate(-18deg); }
          75% { transform: rotate(12deg); }
        }
        .bell-swing { animation: swing 1.2s ease-in-out; transform-origin: top center; }
        
        @keyframes wave {
          0% { transform: scale(1); opacity: 0.6; }
          100% { transform: scale(2.8); opacity: 0; }
        }
        .wave-ring { border-radius: 50%; border: 4px solid rgba(255, 215, 0, 0.4); position: absolute; animation: wave 2s infinite; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
        
        /* Ocultar barra de scroll en iframe si es necesario */
        body { overflow-x: hidden; }
    </style>
</head>
<body>

    <!-- AquÃ­ es donde React va a dibujar la app -->
    <div id="root"></div>

    <!-- 4. Tu CÃ³digo React -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
          getFirestore, 
          collection, 
          addDoc, 
          onSnapshot, 
          query,
          orderBy,
          serverTimestamp 
        } from 'firebase/firestore';
        import { 
          getAuth, 
          signInAnonymously, 
          signInWithCustomToken,
          onAuthStateChanged 
        } from 'firebase/auth';

        // --- TUS DATOS DE FIREBASE AQUÃ ---
        // Reemplaza esto con tu configuraciÃ³n real de Firebase
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROYECTO_ID",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "TUS_NUMEROS",
            appId: "TU_APP_ID"
        };

        // ID de la campaÃ±a (puedes cambiarlo si quieres separar datos)
        const appId = 'campana-fundacion-123';
        const __initial_auth_token = undefined; // Dejar undefined si no usas token personalizado

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const App = () => {
          const [user, setUser] = useState(null);
          const [leads, setLeads] = useState([]);
          const [messages, setMessages] = useState([]);
          const [showLeadModal, setShowLeadModal] = useState(false);
          const [showThanksModal, setShowThanksModal] = useState(false);
          const [isSwinging, setIsSwinging] = useState(false);
          const [formData, setFormData] = useState({ name: '', email: '' });
          const [messageData, setMessageData] = useState('');
          const [loading, setLoading] = useState(false);
          const [errorMessage, setErrorMessage] = useState('');
          
          const audioContextRef = useRef(null);

          // 1. InicializaciÃ³n de AutenticaciÃ³n
          useEffect(() => {
            const initAuth = async () => {
              try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                  await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                  await signInAnonymously(auth);
                }
              } catch (err) {
                console.error("Error de autenticaciÃ³n:", err);
              }
            };
            initAuth();

            const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
              setUser(currentUser);
            });

            return () => unsubscribeAuth();
          }, []);

          // 2. Escucha de Datos (Leads y Mensajes)
          useEffect(() => {
            if (!user) return;

            const leadsRef = collection(db, 'artifacts', appId, 'public', 'data', 'leads');
            const msgsRef = collection(db, 'artifacts', appId, 'public', 'data', 'messages');

            // Escuchar Leads
            const unsubLeads = onSnapshot(leadsRef, (snapshot) => {
              const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setLeads(data);
            }, (err) => console.error("Error leads:", err));

            // Escuchar Mensajes
            const unsubMsgs = onSnapshot(msgsRef, (snapshot) => {
              const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              // Ordenar por timestamp descendente manualmente si falla el Ã­ndice
              const sortedMsgs = data.sort((a, b) => {
                  const timeA = a.timestamp?.seconds || 0;
                  const timeB = b.timestamp?.seconds || 0;
                  return timeB - timeA;
              });
              setMessages(sortedMsgs);
            }, (err) => console.error("Error mensajes:", err));

            return () => {
              unsubLeads();
              unsubMsgs();
            };
          }, [user]);

          // FunciÃ³n para validar formato de email
          const validateEmail = (email) => {
            return String(email)
              .toLowerCase()
              .match(
                /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
              );
          };

          // Sonido "tin-tin-tin-tin"
          const playBellSound = () => {
            try {
              if (!audioContextRef.current) {
                audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
              }
              const ctx = audioContextRef.current;
              
              if (ctx.state === 'suspended') {
                ctx.resume();
              }

              const now = ctx.currentTime;
              
              for (let i = 0; i < 4; i++) {
                const startTime = now + (i * 0.2); 
                
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.frequency.setValueAtTime(1600 + (i * 50), startTime); 
                osc.type = 'sine';
                
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.4, startTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.3);
                
                osc.start(startTime);
                osc.stop(startTime + 0.4);
              }
            } catch (e) {
              console.error("Error al reproducir audio:", e);
            }
          };

          const handleRing = () => {
            setIsSwinging(true);
            playBellSound();
            setTimeout(() => setIsSwinging(false), 1200);
            setTimeout(() => {
              setErrorMessage('');
              setShowLeadModal(true);
            }, 1000);
          };

          const submitLead = async (e) => {
            e.preventDefault();
            if (!user) return;
            
            setLoading(true);
            setErrorMessage('');

            if (!validateEmail(formData.email)) {
              setErrorMessage("Por favor, introduce un correo electrÃ³nico vÃ¡lido.");
              setLoading(false);
              return;
            }

            const emailExists = leads.some(lead => lead.email?.toLowerCase() === formData.email.toLowerCase());
            if (emailExists) {
              setErrorMessage("Este correo ya ha registrado su eco. Â¡Gracias por participar de nuevo!");
              setLoading(false);
              return;
            }

            try {
              const leadsRef = collection(db, 'artifacts', appId, 'public', 'data', 'leads');
              await addDoc(leadsRef, {
                name: formData.name,
                email: formData.email.toLowerCase(),
                uid: user.uid,
                timestamp: serverTimestamp(),
              });
              setShowLeadModal(false);
              setShowThanksModal(true);
            } catch (err) {
              setErrorMessage("No se pudo guardar el eco. Revisa tu conexiÃ³n.");
            } finally {
              setLoading(false);
            }
          };

          const submitMessage = async (e) => {
            e.preventDefault();
            if (!user || !messageData.trim()) return;
            setLoading(true);

            try {
              const msgsRef = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
              await addDoc(msgsRef, {
                name: formData.name || 'AnÃ³nimo',
                message: messageData,
                timestamp: serverTimestamp(),
              });
              setMessageData('');
              setShowThanksModal(false);
            } catch (err) {
              console.error("Error al guardar mensaje:", err);
            } finally {
              setLoading(false);
            }
          };

          const totalEchos = leads.length;
          const workshops = Math.floor(totalEchos / 100);
          const progress = totalEchos % 100;

          return (
            <div className="min-h-screen w-full bg-gradient-to-br from-[#0098d9] via-[#116cc5] to-[#0098d9] font-sans text-white overflow-x-hidden p-4 md:p-8 flex flex-col items-center">
              
              {/* Header */}
              <header className="text-center mb-10 mt-6 animate-in fade-in slide-in-from-top duration-700">
                <h1 className="font-lilita text-5xl md:text-7xl mb-4 drop-shadow-xl">Toca la Campana</h1>
                <p className="text-xl md:text-2xl font-quicksand font-semibold opacity-90">Cada eco financia arteterapia infantil ðŸŽ¨</p>
              </header>

              {/* Contadores */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl mb-12">
                <div className="bg-white rounded-3xl p-8 text-center shadow-2xl transition-transform hover:scale-105">
                  <div className="font-lilita text-7xl text-[#0098d9]">{workshops}</div>
                  <div className="text-[#116cc5] text-xl font-bold mt-2 uppercase tracking-wide">Talleres Logrados</div>
                </div>
                <div className="bg-white rounded-3xl p-8 text-center shadow-2xl transition-transform hover:scale-105">
                  <div className="font-lilita text-7xl text-[#0098d9]">{totalEchos}</div>
                  <div className="text-[#116cc5] text-xl font-bold mt-2 uppercase tracking-wide">Ecos Totales</div>
                </div>
              </div>

              {/* Barra de Progreso */}
              <div className="w-full max-w-3xl mb-12 px-4">
                <div className="bg-white/10 backdrop-blur-md rounded-full p-2 border border-white/20 relative shadow-inner">
                  <div className="bg-white/20 h-14 rounded-full overflow-hidden relative">
                    <div 
                      className="h-full bg-gradient-to-r from-[#ffd058] to-[#ffb800] transition-all duration-1000 shadow-[0_0_25px_rgba(255,208,88,0.7)]"
                      style={{ width: `${progress}%` }}
                    ></div>
                    <div className="absolute inset-0 flex items-center justify-center font-bold text-lg md:text-xl drop-shadow-md">
                      Faltan {100 - progress} ecos para el prÃ³ximo taller
                    </div>
                  </div>
                </div>
              </div>

              {/* Campana Interactiva */}
              <div className="relative mb-12 flex items-center justify-center h-80 md:h-[400px]">
                <div className="wave-ring w-64 h-64 md:w-96 md:h-96" style={{ animationDelay: '0s' }}></div>
                <div className="wave-ring w-64 h-64 md:w-96 md:h-96" style={{ animationDelay: '0.6s' }}></div>
                
                <div 
                  onClick={handleRing}
                  className={`cursor-pointer z-10 relative transition-all hover:scale-110 active:scale-95 ${isSwinging ? 'bell-swing' : ''}`}
                >
                  <svg width="280" height="280" viewBox="0 0 200 200" className="drop-shadow-2xl md:w-[400px] md:h-[400px]">
                    <defs>
                      <linearGradient id="goldGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style={{stopColor:'#ffd700'}} />
                        <stop offset="50%" style={{stopColor:'#ffed4e'}} />
                        <stop offset="100%" style={{stopColor:'#d4af37'}} />
                      </linearGradient>
                    </defs>
                    <g transform="translate(100, 50)">
                      <rect x="-5" y="-20" width="10" height="25" rx="3" fill="url(#goldGrad)" />
                      <path d="M -50 80 Q -50 20 0 0 Q 50 20 50 80 Z" fill="url(#goldGrad)" />
                      <ellipse cx="0" cy="80" rx="55" ry="15" fill="#d4af37" />
                      <ellipse cx="0" cy="80" rx="52" ry="13" fill="url(#goldGrad)" />
                      <line x1="0" y1="10" x2="0" y2="70" stroke="#8b4513" strokeWidth="4" />
                      <circle cx="0" cy="75" r="8" fill="#654321" />
                    </g>
                  </svg>
                </div>
              </div>

              <button 
                onClick={handleRing}
                className="bg-[#ffd058] hover:bg-[#ffb800] text-[#116cc5] font-lilita text-4xl px-16 py-6 rounded-full shadow-[0_15px_30px_rgba(0,0,0,0.3)] transform transition-all hover:scale-105 active:scale-95 mb-16 border-b-8 border-[#d4af37]"
              >
                Â¡HACER SONAR!
              </button>

              {/* Mural */}
              <div className="w-full max-w-5xl mb-20 px-4">
                <h2 className="font-lilita text-3xl md:text-4xl text-center mb-8 drop-shadow-lg tracking-wide">Mural de Esperanza ðŸ’Œ</h2>
                <div className="bg-white/5 backdrop-blur-sm rounded-[40px] p-6 border border-white/10 shadow-2xl min-h-[300px] max-h-[600px] overflow-hidden flex flex-col">
                  {messages.length === 0 ? (
                    <div className="flex-1 flex items-center justify-center text-white/60 font-quicksand text-lg italic">
                      AÃºn no hay mensajes. Â¡SÃ© el primero en dejar uno!
                    </div>
                  ) : (
                    <div className="flex-1 overflow-y-auto custom-scrollbar pr-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 content-start py-4">
                      {messages.map((m, idx) => {
                        const colors = ['#ffd058', '#0098d9', '#116cc5'];
                        const color = colors[idx % colors.length];
                        const rotate = (idx % 2 === 0 ? 1 : -1) * (2 + Math.random() * 2);
                        
                        return (
                          <div 
                            key={m.id || idx} 
                            className="bg-white rounded-xl p-5 shadow-xl transform transition-all hover:scale-110 hover:z-20 animate-in fade-in zoom-in duration-500"
                            style={{ 
                              transform: `rotate(${rotate}deg)`,
                              borderLeft: `8px solid ${color}`
                            }}
                          >
                            <div className="flex justify-between items-start mb-2 border-b border-gray-100 pb-2">
                              <p className="text-[#116cc5] font-bold text-xs uppercase tracking-wider truncate mr-2">{m.name}</p>
                              <span className="text-[10px] text-gray-300">ðŸ“Œ</span>
                            </div>
                            <p className="text-gray-700 font-quicksand text-sm leading-relaxed italic">"{m.message}"</p>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>

              {/* Footer */}
              <div className="bg-white rounded-3xl p-6 md:p-10 max-w-2xl text-center shadow-2xl border-4 border-[#ffd058] mb-10">
                <p className="text-[#116cc5] text-2xl md:text-4xl font-bold leading-tight">
                  ðŸŽ¨ Cada eco financia alegrÃ­a y terapia para los niÃ±os ðŸ’œ
                </p>
              </div>

              {/* Modales */}
              {showLeadModal && (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-[40px] p-8 md:p-12 max-w-md w-full shadow-2xl relative">
                    <button onClick={() => setShowLeadModal(false)} className="absolute top-6 right-8 text-gray-400 hover:text-gray-600 text-4xl">&times;</button>
                    <div className="text-center mb-8">
                      <span className="text-7xl mb-4 block">ðŸ””</span>
                      <h2 className="font-lilita text-4xl text-[#116cc5] mb-2">Â¡Tu eco ya resuena!</h2>
                      <p className="text-gray-500 text-xl font-quicksand">Completa tus datos para sumarlo a la meta</p>
                    </div>
                    {errorMessage && (
                      <div className="bg-red-50 text-red-600 p-4 rounded-xl mb-4 text-center font-bold animate-in fade-in slide-in-from-top duration-300">
                        {errorMessage}
                      </div>
                    )}
                    <form onSubmit={submitLead} className="space-y-6">
                      <input type="text" placeholder="Tu nombre" required className="w-full px-6 py-5 rounded-2xl border-2 border-gray-100 bg-gray-50 focus:border-[#0098d9] focus:bg-white text-gray-800 outline-none transition-all text-lg" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} />
                      <input type="email" placeholder="tu@email.com" required className="w-full px-6 py-5 rounded-2xl border-2 border-gray-100 bg-gray-50 focus:border-[#0098d9] focus:bg-white text-gray-800 outline-none transition-all text-lg" value={formData.email} onChange={(e) => setFormData({...formData, email: e.target.value})} />
                      <button type="submit" disabled={loading} className="w-full bg-[#0098d9] hover:bg-[#116cc5] text-white font-bold py-5 rounded-2xl text-2xl transition-all shadow-xl active:scale-95 disabled:opacity-50">{loading ? 'Validando...' : 'Confirmar mi eco'}</button>
                    </form>
                  </div>
                </div>
              )}

              {showThanksModal && (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-[40px] p-8 md:p-12 max-w-md w-full shadow-2xl">
                    <div className="text-center mb-8">
                      <span className="text-7xl mb-4 block">ðŸ’›</span>
                      <h2 className="font-lilita text-4xl text-[#116cc5] mb-2">Â¡MuchÃ­simas gracias!</h2>
                      <p className="text-gray-500 text-xl font-quicksand">Â¿Te gustarÃ­a dejar unas palabras de esperanza?</p>
                    </div>
                    <form onSubmit={submitMessage} className="space-y-6">
                      <textarea placeholder="Escribe tu mensaje aquÃ­..." rows="4" className="w-full px-6 py-5 rounded-2xl border-none bg-[#116cc5] text-white placeholder-white/60 outline-none transition-all resize-none text-lg shadow-inner" value={messageData} onChange={(e) => setMessageData(e.target.value)} />
                      <div className="flex gap-4">
                        <button type="button" onClick={() => setShowThanksModal(false)} className="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-500 font-bold py-5 rounded-2xl transition-all text-lg">Finalizar</button>
                        <button disabled={loading} className="flex-1 bg-[#ffd058] hover:bg-[#ffb800] text-[#116cc5] font-bold py-5 rounded-2xl transition-all shadow-lg text-lg">{loading ? '...' : 'Enviar ðŸ’Œ'}</button>
                      </div>
                    </form>
                  </div>
                </div>
              )}
            </div>
          );
        };

        // Renderizado en el DOM
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
