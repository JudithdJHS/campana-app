<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campa√±a Fundaci√≥n - Toca la Campana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/app-check": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app-check.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lilita+One&family=Quicksand:wght@400;500;600;700&display=swap');
        .font-lilita { font-family: 'Lilita One', cursive; }
        .font-quicksand { font-family: 'Quicksand', sans-serif; }
        body { background-color: #f8fafc; overflow-x: hidden; }
        @keyframes swing { 0% { transform: rotate(0deg); } 20% { transform: rotate(15deg); } 40% { transform: rotate(-10deg); } 60% { transform: rotate(5deg); } 80% { transform: rotate(-3deg); } 100% { transform: rotate(0deg); } }
        .bell-swing { animation: swing 1.0s ease-in-out; transform-origin: top center; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, limit } from 'firebase/firestore';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { initializeAppCheck, ReCaptchaV3Provider } from 'firebase/app-check';

        const firebaseConfig = {
          apiKey: "AIzaSyCO9aonuABDfwjRjmUTKnPGgKRfNVP5VjU",
          authDomain: "campana-fundacion.firebaseapp.com",
          projectId: "campana-fundacion",
          storageBucket: "campana-fundacion.firebasestorage.app",
          messagingSenderId: "641556114718",
          appId: "1:641556114718:web:0de23bcb20481b19a86d0f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Seguridad App Check
        initializeAppCheck(app, {
          provider: new ReCaptchaV3Provider('6Lc-Q1MsAAAAAO1Qpg2P-oi3knv3XNxg4P3X40ZX'),
          isTokenAutoRefreshEnabled: true
        });

        const App = () => {
          const [user, setUser] = useState(null);
          const [leads, setLeads] = useState([]);
          const [messages, setMessages] = useState([]);
          const [showLeadModal, setShowLeadModal] = useState(false);
          const [showThanksModal, setShowThanksModal] = useState(false);
          const [welcomeMessage, setWelcomeMessage] = useState(false);
          const [showGoalModal, setShowGoalModal] = useState(false);
          const [isSwinging, setIsSwinging] = useState(false);
          const [formData, setFormData] = useState({ name: '', email: '', privacy: false });
          const [messageData, setMessageData] = useState('');
          const audioContextRef = useRef(null);

          useEffect(() => {
            signInAnonymously(auth).catch(e => console.error(e));
            return onAuthStateChanged(auth, setUser);
          }, []);

          useEffect(() => {
            const unsubLeads = onSnapshot(collection(db, 'leads'), s => setLeads(s.docs.map(d => ({id:d.id, ...d.data()}))));
            const q = query(collection(db, 'messages'), orderBy('timestamp', 'desc'), limit(30));
            const unsubMsgs = onSnapshot(q, s => setMessages(s.docs.map(d => ({id:d.id, ...d.data()}))));
            return () => { unsubLeads(); unsubMsgs(); };
          }, []);

          // L√≥gica de Sof√≠a: cada 20 campanadas
          useEffect(() => {
            if (leads.length > 0 && leads.length % 20 === 0) {
              setShowGoalModal(true);
            }
          }, [leads.length]);

          const handleRing = () => {
            setIsSwinging(true);
            setTimeout(() => { setIsSwinging(false); setShowLeadModal(true); }, 1200);
          };

          const submitLead = async (e) => {
            e.preventDefault();
            try {
              await addDoc(collection(db, 'leads'), { name: formData.name, email: formData.email.toLowerCase(), timestamp: serverTimestamp() });
              setShowLeadModal(false); setWelcomeMessage(true);
            } catch (err) { alert("Error"); }
          };

          const submitMessage = async (e) => {
            e.preventDefault();
            try {
              await addDoc(collection(db, 'messages'), { name: formData.name, message: messageData, timestamp: serverTimestamp() });
              setShowThanksModal(false);
            } catch (err) { alert("Error"); }
          };

          const postItColors = ['bg-[#ffe66d]', 'bg-[#ffc6ff]', 'bg-[#9bf6ff]', 'bg-[#ffd6a5]', 'bg-[#caffbf]'];

          return (
            <div className="min-h-screen w-full font-sans text-gray-800 p-4 flex flex-col items-center">
              <header className="text-center mb-8">
                <img src="https://fundacionabrazaunsueno.com/wp-content/uploads/2026/01/toca-la-campana-movil.jpg" className="w-full max-w-md mx-auto rounded-xl shadow-lg" />
                <h1 className="font-lilita text-4xl text-[#0098d9] mt-6">Toca la Campana</h1>
              </header>

              <div onClick={handleRing} className={`cursor-pointer mb-10 ${isSwinging ? 'bell-swing' : ''}`}>
                <svg width="150" height="150" viewBox="0 0 300 300">
                  <path d="M 150 50 Q 150 20 180 20 L 120 20 Q 150 20 150 50 Z" fill="#eab308" />
                  <path d="M 80 230 Q 60 110 120 70 L 180 70 Q 240 110 220 230 Q 270 240 270 260 L 30 260 Q 30 240 80 230 Z" fill="#facc15" />
                </svg>
              </div>

              <div className="grid grid-cols-2 gap-4 w-full max-w-sm mb-10 text-center">
                <div className="bg-[#0098d9] text-white p-4 rounded-2xl">
                  <div className="font-lilita text-4xl">{Math.floor(leads.length / 20)}</div>
                  <p className="text-sm">Talleres</p>
                </div>
                <div className="bg-[#ffd058] p-4 rounded-2xl">
                  <div className="font-lilita text-4xl">{leads.length}</div>
                  <p className="text-sm">Ecos</p>
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 w-full max-w-5xl">
                {messages.map((m, i) => (
                  <div key={i} className={`${postItColors[i % 5]} p-6 rounded-lg shadow-md transform rotate-${i%2===0?1:'-1'}`}>
                    <p className="font-quicksand italic">"{m.message}"</p>
                    <p className="text-right font-bold mt-2">- {m.name}</p>
                  </div>
                ))}
              </div>

              {/* MODALES */}
              {showLeadModal && (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4">
                  <form onSubmit={submitLead} className="bg-white p-8 rounded-[24px] w-full max-w-sm space-y-4">
                    <h2 className="font-lilita text-2xl text-center">¬°Deja tu eco!</h2>
                    <input type="text" placeholder="Nombre" className="w-full border p-3 rounded-lg" onChange={e => setFormData({...formData, name: e.target.value})} required />
                    <input type="email" placeholder="Email" className="w-full border p-3 rounded-lg" onChange={e => setFormData({...formData, email: e.target.value})} required />
                    <button type="submit" className="w-full bg-[#ffd058] font-bold py-3 rounded-xl">REGISTRAR</button>
                  </form>
                </div>
              )}

              {welcomeMessage && (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[101] p-4">
                  <div className="bg-white p-8 rounded-[24px] text-center max-w-sm">
                    <h2 className="font-lilita text-2xl text-[#0098d9] mb-4">¬°GRACIAS POR TU ECO!</h2>
                    <button onClick={() => { setWelcomeMessage(false); setShowThanksModal(true); }} className="w-full bg-[#0098d9] text-white py-3 rounded-xl">Continuar</button>
                  </div>
                </div>
              )}

              {showThanksModal && (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4">
                  <form onSubmit={submitMessage} className="bg-white p-8 rounded-[24px] w-full max-w-sm">
                    <textarea className="w-full border p-4 rounded-lg h-32 mb-4" placeholder="Tu mensaje de esperanza..." onChange={e => setMessageData(e.target.value)}></textarea>
                    <button type="submit" className="w-full bg-[#0098d9] text-white py-3 rounded-xl">ENVIAR MENSAJE</button>
                  </form>
                </div>
              )}

              {showGoalModal && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[200] p-4 backdrop-blur-md">
                  <div className="bg-white rounded-[32px] w-full max-w-md shadow-2xl overflow-hidden text-center">
                    <div className="bg-[#ffd058] p-8">
                      <div className="text-6xl mb-4">üîî</div>
                      <h2 className="font-lilita text-3xl">¬°EL CIELO CELEBRA!</h2>
                      <p className="font-bold opacity-80 uppercase text-xs tracking-widest mt-2">META DE {leads.length} CAMPANADAS LOGRADA</p>
                    </div>
                    <div className="p-8">
                      <p className="font-quicksand text-lg text-gray-700 leading-relaxed mb-6">
                        ¬°Lo has logrado! Hoy, gracias a tu registro, financiamos el <strong>Taller de Arteterapia n¬∫ {leads.length / 20}</strong> para Sof√≠a y sus compa√±eros. üé®‚ú®
                      </p>
                      <button onClick={() => setShowGoalModal(false)} className="w-full bg-[#0098d9] text-white font-bold py-4 rounded-2xl shadow-lg">¬°AM√âN! üôè</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
