<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campa帽a Fundaci贸n - Toca la Campana</title>
    
    <!-- Estilos y Herramientas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lilita+One&family=Quicksand:wght@400;600;700&display=swap');
        .font-lilita { font-family: 'Lilita One', cursive; }
        .font-quicksand { font-family: 'Quicksand', sans-serif; }
        body { background-color: #0098d9; overflow-x: hidden; }
        
        /* Animaciones */
        @keyframes swing { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(20deg); } 50% { transform: rotate(-18deg); } 75% { transform: rotate(12deg); } }
        .bell-swing { animation: swing 1.2s ease-in-out; transform-origin: top center; }
        
        @keyframes wave { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(2.8); opacity: 0; } }
        .wave-ring { border-radius: 50%; border: 4px solid rgba(255, 215, 0, 0.4); position: absolute; animation: wave 2s infinite; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from 'firebase/firestore';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';

        // --- TUS DATOS DE FIREBASE CONFIGURADOS CORRECTAMENTE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCO9aonuABDfwjRjmUTKnPGgKRfNVP5VjU",
          authDomain: "campana-fundacion.firebaseapp.com",
          projectId: "campana-fundacion",
          storageBucket: "campana-fundacion.firebasestorage.app",
          messagingSenderId: "641556114718",
          appId: "1:641556114718:web:0de23bcb20481b19a86d0f"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const App = () => {
          const [user, setUser] = useState(null);
          const [leads, setLeads] = useState([]);
          const [messages, setMessages] = useState([]);
          const [showLeadModal, setShowLeadModal] = useState(false);
          const [showThanksModal, setShowThanksModal] = useState(false);
          const [isSwinging, setIsSwinging] = useState(false);
          const [formData, setFormData] = useState({ name: '', email: '' });
          const [messageData, setMessageData] = useState('');
          const [loading, setLoading] = useState(false);
          const [errorMessage, setErrorMessage] = useState('');
          
          const audioContextRef = useRef(null);

          // 1. Autenticaci贸n (Entrada An贸nima)
          useEffect(() => {
            signInAnonymously(auth).catch((error) => {
                console.error("Error Auth:", error);
                // Si esto falla, es porque no est谩 habilitado "An贸nimo" en la consola de Firebase
                alert("Error de conexi贸n: Revisa si habilitaste la autenticaci贸n 'An贸nima' en Firebase Console.");
            });
            return onAuthStateChanged(auth, setUser);
          }, []);

          // 2. Escuchar la Base de Datos
          useEffect(() => {
            // Referencias directas a las colecciones
            const leadsRef = collection(db, 'leads');
            const msgsRef = collection(db, 'messages');

            // Actualizar contadores en tiempo real
            const unsubLeads = onSnapshot(leadsRef, (snapshot) => {
              const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setLeads(data);
            }, (error) => {
                console.log("Esperando permisos...", error);
            });

            // Actualizar mensajes en tiempo real
            const unsubMsgs = onSnapshot(msgsRef, (snapshot) => {
              const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              // Ordenar: el m谩s reciente primero
              data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
              setMessages(data);
            });

            return () => { unsubLeads(); unsubMsgs(); };
          }, []);

          // Sonido de Campana
          const playBellSound = () => {
            try {
              if (!audioContextRef.current) audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
              const ctx = audioContextRef.current;
              if (ctx.state === 'suspended') ctx.resume();
              const now = ctx.currentTime;
              
              // 4 repiques (tin-tin-tin-tin)
              for (let i = 0; i < 4; i++) {
                const startTime = now + (i * 0.2); 
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(1600 + (i * 50), startTime); 
                osc.type = 'sine';
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.4, startTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.3);
                osc.start(startTime);
                osc.stop(startTime + 0.4);
              }
            } catch (e) { console.error("Audio error", e); }
          };

          const handleRing = () => {
            setIsSwinging(true);
            playBellSound();
            setTimeout(() => setIsSwinging(false), 1200);
            setTimeout(() => {
              setErrorMessage('');
              setShowLeadModal(true);
            }, 1000);
          };

          const validateEmail = (email) => String(email).toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/);

          // Guardar Lead (Nombre y Correo)
          const submitLead = async (e) => {
            e.preventDefault();
            if (!user) { alert("Conectando con el servidor... intenta en 5 segundos."); return; }
            setLoading(true);
            setErrorMessage('');

            if (!validateEmail(formData.email)) {
              setErrorMessage("Correo inv谩lido."); setLoading(false); return;
            }

            if (leads.some(l => l.email?.toLowerCase() === formData.email.toLowerCase())) {
               setErrorMessage("隆Ya registraste tu eco! Gracias."); setLoading(false); return;
            }

            try {
              await addDoc(collection(db, 'leads'), {
                name: formData.name,
                email: formData.email.toLowerCase(),
                uid: user.uid,
                timestamp: serverTimestamp(),
              });
              setShowLeadModal(false);
              setShowThanksModal(true);
            } catch (err) {
              console.error(err);
              alert("Error al guardar. Verifica que las 'Reglas' de Firebase est茅n en modo p煤blico.");
            } finally {
              setLoading(false);
            }
          };

          // Guardar Mensaje del Mural
          const submitMessage = async (e) => {
            e.preventDefault();
            if (!user || !messageData.trim()) return;
            setLoading(true);
            try {
              await addDoc(collection(db, 'messages'), {
                name: formData.name || 'An贸nimo',
                message: messageData,
                timestamp: serverTimestamp(),
              });
              setMessageData('');
              setShowThanksModal(false);
            } catch (err) {
              alert("Error mensaje: " + err.message);
            } finally {
              setLoading(false);
            }
          };

          const totalEchos = leads.length;
          const workshops = Math.floor(totalEchos / 100);
          const progress = totalEchos % 100;

          return (
            <div className="min-h-screen w-full bg-gradient-to-br from-[#0098d9] via-[#116cc5] to-[#0098d9] font-sans text-white overflow-x-hidden p-4 md:p-8 flex flex-col items-center">
              
              {/* Header */}
              <header className="text-center mb-10 mt-6 animate-in fade-in slide-in-from-top duration-700">
                <h1 className="font-lilita text-5xl md:text-7xl mb-4 drop-shadow-xl text-[#ffd058]" style={{textShadow: '2px 2px 0px #116cc5'}}>Toca la Campana</h1>
                <p className="text-xl md:text-2xl font-quicksand font-bold">Cada eco financia arteterapia infantil </p>
              </header>

              {/* Contadores */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl mb-12">
                <div className="bg-white rounded-3xl p-6 text-center shadow-[0_10px_20px_rgba(0,0,0,0.2)] transform hover:scale-105 transition-all">
                  <div className="font-lilita text-6xl text-[#0098d9]">{workshops}</div>
                  <div className="text-[#116cc5] text-xl font-bold uppercase tracking-wide">Talleres Logrados</div>
                </div>
                <div className="bg-white rounded-3xl p-6 text-center shadow-[0_10px_20px_rgba(0,0,0,0.2)] transform hover:scale-105 transition-all">
                  <div className="font-lilita text-6xl text-[#0098d9]">{totalEchos}</div>
                  <div className="text-[#116cc5] text-xl font-bold uppercase tracking-wide">Ecos Totales</div>
                </div>
              </div>

              {/* Barra */}
              <div className="w-full max-w-3xl mb-12 px-4">
                <div className="bg-[#116cc5]/30 backdrop-blur-md rounded-full p-2 border border-white/20">
                  <div className="bg-white/20 h-12 rounded-full overflow-hidden relative">
                    <div className="h-full bg-gradient-to-r from-[#ffd058] to-[#ffb800]" style={{ width: `${progress}%`, transition: 'width 1s ease' }}></div>
                    <div className="absolute inset-0 flex items-center justify-center font-bold text-white drop-shadow-md">
                      Faltan {100 - progress} ecos para el pr贸ximo taller
                    </div>
                  </div>
                </div>
              </div>

              {/* Campana */}
              <div className="relative mb-12 flex items-center justify-center h-72 md:h-96">
                <div className="wave-ring w-64 h-64 md:w-80 md:h-80" style={{ animationDelay: '0s' }}></div>
                <div className="wave-ring w-64 h-64 md:w-80 md:h-80" style={{ animationDelay: '0.6s' }}></div>
                <div onClick={handleRing} className={`cursor-pointer z-10 relative transition-all hover:scale-110 active:scale-95 ${isSwinging ? 'bell-swing' : ''}`}>
                   <svg width="250" height="250" viewBox="0 0 200 200" className="drop-shadow-2xl">
                    <defs>
                      <linearGradient id="goldGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style={{stopColor:'#ffd700'}} />
                        <stop offset="100%" style={{stopColor:'#d4af37'}} />
                      </linearGradient>
                    </defs>
                    <g transform="translate(100, 50)">
                      <rect x="-5" y="-20" width="10" height="25" rx="3" fill="#d4af37" />
                      <path d="M -50 80 Q -50 20 0 0 Q 50 20 50 80 Z" fill="url(#goldGrad)" />
                      <ellipse cx="0" cy="80" rx="55" ry="15" fill="#d4af37" />
                      <ellipse cx="0" cy="80" rx="52" ry="13" fill="url(#goldGrad)" />
                      <circle cx="0" cy="75" r="8" fill="#654321" />
                    </g>
                  </svg>
                </div>
              </div>

              <button onClick={handleRing} className="bg-[#ffd058] text-[#116cc5] font-lilita text-3xl px-12 py-5 rounded-full shadow-xl hover:bg-[#ffb800] hover:scale-105 active:scale-95 transition-all mb-16 border-b-8 border-[#d4af37]">
                隆HACER SONAR!
              </button>

              {/* Mural */}
              <div className="w-full max-w-5xl mb-20 px-4">
                <div className="flex items-center justify-center gap-3 mb-8">
                    <h2 className="font-lilita text-4xl text-white drop-shadow-md">Mural de Esperanza</h2>
                    <span className="text-3xl"></span>
                </div>
                
                <div className="bg-white/10 backdrop-blur-sm rounded-[30px] p-8 border border-white/20 min-h-[300px]">
                  {messages.length === 0 ? (
                    <div className="text-center text-white/70 font-quicksand text-xl italic py-10">
                      <p>A煤n no hay mensajes en el muro.</p>
                      <p className="text-sm mt-2">隆S茅 el primero en tocar la campana y dejar uno!</p>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                      {messages.map((m, idx) => (
                        <div key={idx} className="bg-white p-6 rounded-tr-3xl rounded-bl-3xl rounded-tl-md rounded-br-md shadow-lg transform hover:-translate-y-1 transition-all">
                          <div className="flex justify-between mb-3 border-b border-gray-100 pb-2">
                            <span className="font-bold text-[#116cc5] uppercase text-xs tracking-wider">{m.name}</span>
                            <span className="text-red-400"></span>
                          </div>
                          <p className="text-gray-600 font-quicksand italic text-sm leading-relaxed">"{m.message}"</p>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* Modales */}
              {showLeadModal && (
                <div className="fixed inset-0 bg-[#001f3f]/90 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                  <div className="bg-white rounded-[30px] p-8 max-w-sm w-full text-center shadow-2xl relative animate-in zoom-in duration-300">
                    <button onClick={() => setShowLeadModal(false)} className="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
                    <div className="text-6xl mb-4"></div>
                    <h2 className="text-[#116cc5] font-lilita text-3xl mb-2">隆Tu eco ya resuena!</h2>
                    <p className="text-gray-500 mb-6 text-sm">Completa tus datos para sumarlo a la meta</p>
                    
                    {errorMessage && <div className="bg-red-100 text-red-600 p-2 rounded mb-4 text-xs font-bold">{errorMessage}</div>}
                    
                    <form onSubmit={submitLead} className="space-y-4">
                      <input type="text" placeholder="Tu nombre" className="w-full bg-gray-50 border-2 border-gray-100 rounded-xl px-4 py-3 outline-none focus:border-[#0098d9] text-gray-700" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required />
                      <input type="email" placeholder="tu@email.com" className="w-full bg-gray-50 border-2 border-gray-100 rounded-xl px-4 py-3 outline-none focus:border-[#0098d9] text-gray-700" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} required />
                      <button type="submit" disabled={loading} className="w-full bg-[#116cc5] text-white font-bold py-3 rounded-xl hover:bg-[#005bb5] transition-colors shadow-lg">
                        {loading ? 'Enviando...' : 'Confirmar mi eco'}
                      </button>
                    </form>
                  </div>
                </div>
              )}

              {showThanksModal && (
                <div className="fixed inset-0 bg-[#001f3f]/90 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                  <div className="bg-white rounded-[30px] p-8 max-w-sm w-full text-center shadow-2xl animate-in zoom-in duration-300">
                    <div className="text-6xl mb-4"></div>
                    <h2 className="text-[#116cc5] font-lilita text-3xl mb-2">隆Gracias!</h2>
                    <p className="text-gray-500 mb-6 text-sm">Deja un mensaje de esperanza para el mural</p>
                    <form onSubmit={submitMessage}>
                      <textarea className="w-full bg-[#f0f9ff] border-none rounded-xl p-4 text-gray-700 mb-4 focus:ring-2 focus:ring-[#116cc5] outline-none h-32 resize-none text-sm" placeholder="Escribe algo bonito aqu铆..." value={messageData} onChange={e => setMessageData(e.target.value)}></textarea>
                      <div className="flex gap-2">
                        <button type="button" onClick={() => setShowThanksModal(false)} className="flex-1 py-3 text-gray-400 font-bold text-sm">Saltar</button>
                        <button type="submit" disabled={loading} className="flex-1 bg-[#ffd058] text-[#116cc5] font-bold py-3 rounded-xl hover:bg-[#ffb800] shadow-md">
                          {loading ? '...' : 'Publicar '}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              )}

            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
